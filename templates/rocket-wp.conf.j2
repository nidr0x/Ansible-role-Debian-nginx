# {{ ansible_managed }}

set $rocket_debug 0;

set $rocket_hsts_value "";

set $rocket_wpcontent_directory "$document_root/wp-content";

set $rocket_wpcontent_url "/wp-content";

set $rocket_bypass 1;
set $rocket_encryption "";
set $rocket_file "";
set $rocket_is_bypassed "No";
set $rocket_reason "";
set $rocket_https_prefix "";
set $rocket_hsts 0;

set $rocket_hsts_value_default "max-age=31536000; includeSubDomains";

if ($http_accept_encoding ~ gzip) {
	set $rocket_encryption "_gzip";
}

if ($https = "on") {
	set $rocket_https_prefix "-https";
	set $rocket_hsts 1;
}

if ($rocket_hsts_value = "") {
	set $rocket_hsts_value "$rocket_hsts_value_default";
}

if ($rocket_hsts = "0") {
	set $rocket_hsts_value "";
}

set $rocket_end "/cache/wp-rocket/$http_host/$request_uri/index$rocket_https_prefix.html$rocket_encryption";
set $rocket_url "$rocket_wpcontent_url$rocket_end";
set $rocket_file "$rocket_wpcontent_directory$rocket_end";
set $rocket_mobile_detection "$rocket_wpcontent_directory/cache/wp-rocket/$http_host/$request_uri/.mobile-active";

if ($request_method = POST) {
	set $rocket_bypass 0;
	set $rocket_reason "POST request";
}

if ($is_args) {
	set $rocket_bypass 0;
	set $rocket_reason "Arguments found";
}

if (-f "$document_root/.maintenance") {
	set $rocket_bypass 0;
	set $rocket_reason "Maintenance mode";
}

if ($http_cookie ~* "(wordpress_logged_in_|wp\-postpass_|woocommerce_items_in_cart|woocommerce_cart_hash|wptouch_switch_toogle|comment_author_|comment_author_email_)") {
	set $rocket_bypass 0;
	set $rocket_reason "Cookie";
}

if (-f "$rocket_mobile_detection") {
	set $rocket_bypass 0;
	set $rocket_reason "Specific mobile cache activated";	
}

if (!-f "$rocket_file") {
	set $rocket_bypass 0;
	set $rocket_reason "File not cached";
}

if ($rocket_bypass = 1) {
	set $rocket_is_bypassed "Yes";
	set $rocket_reason "$rocket_url";
}

if ($rocket_debug = 0) {
	set $rocket_reason "";
	set $rocket_file "";
}

if ($rocket_bypass = 1) {
	rewrite .* "$rocket_url" last;
}

location ~ /wp-content/cache/wp-rocket/.*html$ {
	add_header Vary "Accept-Encoding, Cookie";
	add_header X-Rocket-Nginx-Bypass $rocket_is_bypassed;
	add_header X-Rocket-Nginx-Reason $rocket_reason;
	add_header X-Rocket-Nginx-File $rocket_file;
	add_header Strict-Transport-Security "$rocket_hsts_value";
	expires 30d;
	
	#!# HEADER_HTTP #!#
	#!# HEADER_NON_GZIP #!#
}

location ~ /wp-content/cache/wp-rocket/.*_gzip$ {
	gzip off;
	types {}
	default_type text/html;
	add_header Content-Encoding gzip;
	add_header Vary "Accept-Encoding, Cookie";
	add_header X-Rocket-Nginx-Bypass $rocket_is_bypassed;
	add_header X-Rocket-Nginx-Reason $rocket_reason;
	add_header X-Rocket-Nginx-File $rocket_file;
	add_header Strict-Transport-Security "$rocket_hsts_value";
	expires 30d;

}

add_header X-Rocket-Nginx-Bypass $rocket_is_bypassed;
add_header X-Rocket-Nginx-Reason $rocket_reason;
add_header X-Rocket-Nginx-File $rocket_file;

location ~* \.css$ {
	gzip_vary on;
	expires 30d;
	
	#!# HEADER_CSS #!#
}

location ~* \.js$ {
	gzip_vary on;
	expires 30d;
	
	#!# HEADER_JS #!#
}

location ~* \.(ico|gif|jpe?g|png|svg|eot|otf|woff|woff2|ttf|ogg)$ {
	expires 30d;
	
	#!# HEADER_MEDIAS #!#
}